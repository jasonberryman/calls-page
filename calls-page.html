<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../calls-item/calls-item.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../polymer/polymer.html">
<!--
  `<calls-page></calls-page>` demo
  @demo demo.html
-->
<dom-module id="calls-page">
  <template>
    <style>
      :host {
        display:block;
        width: 95%;
        margin-top: 10px;
        margin-left: 2.5%;
      }
      calls-item.iron-selected {
        max-height: 700px;
        margin: 50px -10px;
      };
    </style>
    <template is="dom-if" if="[[!list.length]]">
      no data / loading ...
    </template>
    
    <iron-selector attr-for-selected="id" selected="{{callSelected}}">
      <template is="dom-repeat" items="{{list}}">
        <calls-item  
          call-selected="[[callSelected]]"
          received="[[item.timeLocal.received]]" 
          answered="[[item.timeLocal.answered]]"
          on-tap="closeNotSelected"
          from="[[item.source.displayName]]"
          legs="[[legs]]"
          to="[[item.target.displayName]]"
          id="[[item.__key]]"
        ></calls-item>
      </template>
    </iron-selector>
  </template>
</dom-module>
<script>
  Polymer({
    is: "calls-page",
    properties:{
      list:{
        type:Array,
        value:[],
      },
      customerDomain: {
        value: "example.com"
      },
      _getReady: {
        computed: "getReady(customerDomain)"
      },
      _legs: {
        computed: "getLegs(callSelected, context)"
      },
    },
    getLegs: function(callSelected, context) {
      var that = this
      if (!this.unsubscribe) {
        this.unsubscribe = {}
      } else {
        for (var callUnsubscribe in this.unsubscribe) {
          this.unsubscribe[callUnsubscribe]()
        }
      }
      this.unsubscribe[callSelected] = this.context.collection(callSelected).doc("legs").onSnapshot(function(doc) {
        if (doc) {
          var legs = []
          for (var index in doc.docs) {
            var data = doc.docs[index].data()
            data.__key = doc.docs[index].id
            console.log("collection legs data:", data)
            legs.push(data)
          }
          that.legs = legs
        } else {
          console.log("No such collection!")
        }
      })
    },
    closeNotSelected: function(){
      var that = this
      if (this.$$("calls-item.iron-selected")) {
        this.$$("calls-item.iron-selected").close()
        setTimeout(function () {
          that.$$("calls-item.iron-selected").open()
        },1)
      }
    },
    getReady: function(customerDomain){
      var that = this
      this.context = firebase.firestore().collection("calls")
        .where('receivedUTC', '>', 0)
        .where('customerDomain', '==', customerDomain)
        .where('state', '==', 'completed')
      this.context.orderBy('receivedUTC', 'desc').onSnapshot(function(doc) {
        if (doc) {
          var list = []
          for (var index in doc.docs) {
            var data = doc.docs[index].data()
            data.__key = doc.docs[index].id
            console.log("Document data:", data)
            list.push(data)
          }
          that.list = list
        } else {
          console.log("No such document!")
        }
      })
    },
  })
</script>
